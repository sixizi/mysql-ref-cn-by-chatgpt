# **27.2.1 存储例程语法**





存储例程（Stored Routine）可以是**存储过程（Procedure）或函数（Function）**。

存储例程使用 CREATE PROCEDURE 和 CREATE FUNCTION 语句创建（参见 [15.1.17, CREATE PROCEDURE and CREATE FUNCTION Statements](#)）。



- **存储过程（Procedure）** 使用 CALL 语句调用（参见 [15.2.1, CALL Statement](#)），并且只能通过**输出变量（Output Variables）**返回值。
- **函数（Function）** 可以像其他函数一样在语句中调用（即通过函数名调用），并返回一个**标量值（Scalar Value）**。





存储例程的主体可以使用**复合语句（Compound Statements）**（参见 [15.6, Compound Statement Syntax](#)）。



------



存储例程可以使用 DROP PROCEDURE 和 DROP FUNCTION 删除（参见 [15.1.29, DROP PROCEDURE and DROP FUNCTION Statements](#)），也可以使用 ALTER PROCEDURE 和 ALTER FUNCTION 修改（参见 [15.1.7, ALTER PROCEDURE Statement](#)）。



------



一个存储过程或函数**绑定到特定数据库**，这带来以下影响：





- > 当调用例程时，会隐式执行 USE db_name（例程结束时撤销）。存储例程中**不允许使用 USE 语句**。

- > 可以使用**数据库名限定例程名**，以调用不在当前数据库的例程。例如，要调用属于 test 数据库的存储过程 p 或函数 f，可以写：



```
CALL test.p();
SELECT test.f();
```



- > 

- > 当数据库被删除时，与之关联的所有存储例程也会被删除。





------





- **存储函数（Stored Functions）** 不能递归。

- **存储过程（Stored Procedures）** 可以递归，但默认禁用。若要启用递归，需将服务器系统变量 max_sp_recursion_depth 设置为大于 0 的值。

  

  - 存储过程递归会增加线程栈空间需求。
  - 如果增加了 max_sp_recursion_depth，可能需要在服务器启动时调整 thread_stack 以增加线程栈大小。
  - 详情参见 [7.1.8, Server System Variables](#)。

  





------



MySQL 提供了一个非常实用的扩展，允许在存储过程中使用常规 SELECT 语句（即不使用游标或局部变量）。



- 这样的查询结果集会直接发送给客户端。
- 多个 SELECT 语句会生成多个结果集，因此客户端必须使用支持**多结果集（Multiple Result Sets）**的 MySQL 客户端库。
- 这要求客户端使用 **MySQL 4.1 或更新版本**的客户端库，并在连接时指定 CLIENT_MULTI_RESULTS 选项。
- 对于 C 程序，可以通过 mysql_real_connect() C API 函数实现（参见 mysql_real_connect() 和 *Multiple Statement Execution Support*）。





------



在 **MySQL 8.0.22 及更高版本**中，存储过程中语句引用的**用户变量（User Variable）**，其数据类型会在**首次调用**存储过程时确定，并在之后的每次调用中保持不变。

