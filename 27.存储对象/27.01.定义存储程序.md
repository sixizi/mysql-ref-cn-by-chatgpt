## **27.1 定义存储程序**





每个**存储程序**都包含一个由 SQL 语句组成的**主体**（body）。

该语句可以是一个**复合语句**（compound statement），由多个以分号 (;) 分隔的语句组成。



例如，下面的存储过程主体是一个 BEGIN ... END 块，其中包含一个 SET 语句和一个 REPEAT 循环（循环内还有另一个 SET 语句）：

```
CREATE PROCEDURE dorepeat(p1 INT)
BEGIN
  SET @x = 0;
  REPEAT SET @x = @x + 1; UNTIL @x > p1 END REPEAT;
END;
```



------





### **在** 

### **mysql**

###  **客户端中处理分号冲突**





如果你在 mysql 客户端定义包含分号的存储程序，会出现一个问题：

默认情况下，mysql 会将分号识别为**语句分隔符**，因此必须**临时重新定义分隔符**，让 mysql 将整个存储程序定义一次性传递给服务器。



------





### **重新定义分隔符**





使用 delimiter 命令可更改 mysql 客户端的语句分隔符。

下面的示例演示了如何为刚才的 dorepeat() 过程重新定义分隔符：



1. 将分隔符改为 //，这样整个定义会作为一个完整语句传给服务器。
2. 定义完成后，将分隔符恢复为 ;，然后再调用过程。
3. 这样，过程主体中的分号 ; 会直接传递到服务器，而不会被 mysql 客户端截断。



```
mysql> delimiter //

mysql> CREATE PROCEDURE dorepeat(p1 INT)
    -> BEGIN
    ->   SET @x = 0;
    ->   REPEAT SET @x = @x + 1; UNTIL @x > p1 END REPEAT;
    -> END
    -> //
Query OK, 0 rows affected (0.00 sec)

mysql> delimiter ;

mysql> CALL dorepeat(1000);
Query OK, 0 rows affected (0.00 sec)

mysql> SELECT @x;
+------+
| @x   |
+------+
| 1001 |
+------+
1 row in set (0.00 sec)
```



------





### **分隔符注意事项**





- 分隔符可以改为除 // 之外的任意字符串，可以是**单个字符**或**多个字符**。
- **避免使用反斜杠**（\），因为它在 MySQL 中是**转义字符**。





------





### **不需要修改分隔符的情况**





如果存储程序的定义中**不包含内部语句分隔符 ;**，就不必修改分隔符。

例如，下面的函数只有一个 RETURN 语句，因此无需更改分隔符：

```
mysql> CREATE FUNCTION hello (s CHAR(20))
mysql> RETURNS CHAR(50) DETERMINISTIC
    -> RETURN CONCAT('Hello, ',s,'!');
Query OK, 0 rows affected (0.00 sec)

mysql> SELECT hello('world');
+----------------+
| hello('world') |
+----------------+
| Hello, world!  |
+----------------+
1 row in set (0.00 sec)
```



------



我注意到 27.2 会讲 **Using Stored Routines**，可以帮你直接继续翻译成中文并保持格式一致，这样这一章就会很连贯。你要我直接接着翻吗？