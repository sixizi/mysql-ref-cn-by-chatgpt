#### 7.6.7.7 用于复制的克隆

clone 插件支持复制功能。克隆操作不仅复制数据，还会从 donor 提取复制坐标并传输给 recipient，使得可以使用 clone 插件为组复制成员（Group Replication members）和复制副本（replicas）进行初始化。相比复制大量事务，使用 clone 插件初始化实例的速度更快、效率更高。

组复制成员还可以配置为在分布式恢复中使用 clone 插件，在这种情况下，新加入的成员将自动选择最有效的方式从现有成员获取数据。详见 [第 20.5.4.2 节，分布式恢复的克隆](#20-5-4-2-cloning-for-distributed-recovery)。

在克隆过程中，donor MySQL 实例上的二进制日志位置（文件名与偏移量）和 `gtid_executed` 的 GTID 集将被提取并传输到 recipient。这些信息允许在复制流中以一致的位置启动复制。

> **注意**
>
> 二进制日志和中继日志（relay logs）文件本身不会被克隆。
>
> 要成功启动复制，必须确保在克隆完成到启动复制之间，这些日志未被清除。否则将导致握手错误。
>
> 因此，克隆完成后应尽快将 recipient 添加到复制拓扑中，以避免所需日志被清理或实例滞后过多。

在克隆后的 MySQL 实例中运行以下查询可查看接收的二进制日志位置：

```
SELECT BINLOG_FILE, BINLOG_POSITION FROM performance_schema.clone_status;
```

查看传输过来的 GTID 集：

```
SELECT @@GLOBAL.GTID_EXECUTED;
```

MySQL 8.0 默认使用表来保存复制元数据仓库，这些表在克隆过程中会被复制：

- MySQL 8.0.17 和 8.0.18：仅复制 `mysql.slave_master_info`（连接元数据仓库）
- 从 MySQL 8.0.19 开始：同时复制 `mysql.slave_relay_log_info`（执行器元数据）和 `mysql.slave_worker_info`（执行器工作线程元数据）

关于这些表内容详见 [第 19.2.4.2 节，复制元数据仓库](#19-2-4-2-replication-metadata-repositories)。若服务器配置为 `master_info_repository=FILE` 或 `relay_log_info_repository=FILE`（MySQL 8.0 默认不是此配置，且已弃用），则不会克隆元数据仓库，只有设置为 `TABLE` 时才会克隆。

要为复制克隆，执行下面的步骤：

1. 对于组复制的新成员，首先按照 [第 20.2.1.6 节，向组添加实例](#20-2-1-6-adding-instances-to-the-group) 配置 MySQL 实例用于组复制，并设置 [分布式恢复的克隆前提条件](#20-5-4-2-cloning-for-distributed-recovery)。执行 `START GROUP_REPLICATION` 时，clone 操作将由组复制自动管理，无需手动操作，也无需进一步配置。

2. 对于主从复制拓扑中的副本，从 donor MySQL 实例手动将数据克隆到 recipient。donor 必须是拓扑中的 source 或 replica。具体操作见：[7.6.7.3 远程克隆数据](#7-6-7-3-cloning-remote-data)。

3. 克隆完成后，如果希望在 recipient 上继续使用与 donor 相同的复制通道，请验证哪些通道可以自动恢复，哪些需要手动设置。

   - 对于使用 GTID 的复制，如果 recipient 的 `gtid_mode=ON`，且从启用了 `gtid_mode=ON`、`ON_PERMISSIVE` 或 `OFF_PERMISSIVE` 的 donor 克隆，则 recipient 会继承 `gtid_executed`。若 recipient 是从拓扑中已有的副本克隆而来，则启用 GTID 自动定位的通道可在克隆完成后自动恢复，无需手动配置。
   - 对于使用二进制日志位置的复制，MySQL 8.0.17 或 8.0.18中，recipient 不会应用 donor 的日志位置，仅记录于 `performance_schema.clone_status`。此类通道必须**手动配置**，且不要设置为开机自动启动。MySQL 8.0.19 起，recipient 会自动应用 donor 的日志位置。相关通道会尝试执行中继日志恢复流程，再重新启动复制：
   - 对于基于二进制日志位置的复制，如果 recipient 使用的是 MySQL 8.0.19 或更高版本，来自 donor 的二进制日志位置会被应用到 recipient 上。在 recipient 上，使用基于二进制日志位置复制的复制通道会在重启复制之前，自动尝试执行中继日志恢复过程，并使用克隆的中继日志信息。对于单线程副本（replica_parallel_workers 或 slave_parallel_workers 设置为 0），如果没有其他问题，中继日志恢复应该会成功，使通道能够无需进一步设置就恢复复制。对于多线程副本（replica_parallel_workers 或 slave_parallel_workers 大于 0），中继日志恢复很可能会失败，因为它通常无法自动完成。在这种情况下，会发出错误消息，必须手动设置该通道。

4. 如果你需要手动设置克隆后的复制通道，或者希望在 recipient 上使用不同的复制通道，以下说明提供了一个概览和简化示例，展示如何将 recipient MySQL 服务器实例添加到复制拓扑中。你还应参考适用于你具体复制配置的详细说明。

   - 要将 recipient MySQL 服务器实例添加到使用 **基于 GTID 的事务** 作为复制数据源的 MySQL 复制拓扑中，请按照 [第 19.1.3.4 节，使用 GTID 设置复制](#19-1-3-4-setting-up-replication-using-gtids) 的指引配置实例。为该实例添加复制通道，如下所示（简化示例），从 MySQL 8.0.23 起使用 `CHANGE REPLICATION SOURCE TO`；在此之前版本使用 `CHANGE MASTER TO`。必须在语句中指定 source 的主机地址和端口号，并启用 `SOURCE_AUTO_POSITION` 或 `MASTER_AUTO_POSITION` 选项，如下所示：

     ```mysql
     mysql> CHANGE MASTER TO MASTER_HOST = 'source_host_name', MASTER_PORT = source_port_num,
            ...
            MASTER_AUTO_POSITION = 1,
            FOR CHANNEL 'setup_channel';
     mysql> START SLAVE USER = 'user_name' PASSWORD = 'password' FOR CHANNEL 'setup_channel';
     
     Or from MySQL 8.0.22 and 8.0.23:
     
     mysql> CHANGE SOURCE TO SOURCE_HOST = 'source_host_name', SOURCE_PORT = source_port_num,
            ...
            SOURCE_AUTO_POSITION = 1,
            FOR CHANNEL 'setup_channel';
     mysql> START REPLICA USER = 'user_name' PASSWORD = 'password' FOR CHANNEL 'setup_channel';
     ```

   - 要将 recipient MySQL 服务器实例添加到使用 **基于二进制日志位置** 的 MySQL 复制拓扑中，请按照 [第 19.1.2 节，设置基于二进制日志位置的复制](#19-1-2-setting-up-binary-log-file-position-based-replication) 中的说明进行配置。为该实例添加复制通道，如下所示（简化示例），使用克隆操作中传输到 recipient 的二进制日志位置：

     ```mysql
     mysql> SELECT BINLOG_FILE, BINLOG_POSITION FROM performance_schema.clone_status;
     mysql> CHANGE MASTER TO MASTER_HOST = 'source_host_name', MASTER_PORT = source_port_num,
            ...
            MASTER_LOG_FILE = 'source_log_name',
            MASTER_LOG_POS = source_log_pos,
            FOR CHANNEL 'setup_channel';
     mysql> START SLAVE USER = 'user_name' PASSWORD = 'password' FOR CHANNEL 'setup_channel';
     
     Or from MySQL 8.0.22 and 8.0.23:
     
     mysql> SELECT BINLOG_FILE, BINLOG_POSITION FROM performance_schema.clone_status;
     mysql> CHANGE SOURCE TO SOURCE_HOST = 'source_host_name', SOURCE_PORT = source_port_num,
            ...
            SOURCE_LOG_FILE = 'source_log_name',
            SOURCE_LOG_POS = source_log_pos,
            FOR CHANNEL 'setup_channel';
     mysql> START REPLICA USER = 'user_name' PASSWORD = 'password' FOR CHANNEL 'setup_channel';
     ```

     