



## **7.6.7.7 用于复制的克隆（Cloning for Replication）**





clone 插件支持复制功能。克隆操作不仅复制数据，还会从 donor 提取复制坐标并传输给 recipient，使得可以使用 clone 插件为组复制成员（Group Replication members）和复制副本（replicas）进行初始化。相比复制大量事务，使用 clone 插件初始化实例的速度更快、效率更高。



组复制成员还可以配置为在分布式恢复中使用 clone 插件，在这种情况下，新加入的成员将自动选择最有效的方式从现有成员获取数据。详见 [第 20.5.4.2 节，分布式恢复的克隆](#20-5-4-2-cloning-for-distributed-recovery)。



在克隆过程中，donor MySQL 实例上的二进制日志位置（文件名与偏移量）和 `gtid_executed` 的 GTID 集将被提取并传输到 recipient。这些信息允许在复制流中以一致的位置启动复制。



> **注意**

> 二进制日志和中继日志（relay logs）文件本身不会被克隆。

> 要成功启动复制，必须确保在克隆完成到启动复制之间，这些日志未被清除。否则将导致握手错误。

> 因此，克隆完成后应尽快将 recipient 添加到复制拓扑中，以避免所需日志被清理或实例滞后过多。



在克隆后的 MySQL 实例中运行以下查询可查看接收的二进制日志位置：

```
SELECT BINLOG_FILE, BINLOG_POSITION FROM performance_schema.clone_status;
```

查看传输过来的 GTID 集：

```
SELECT @@GLOBAL.GTID_EXECUTED;
```

MySQL 8.0 默认使用表来保存复制元数据仓库，这些表在克隆过程中会被复制：



- MySQL 8.0.17 和 8.0.18：仅复制 `mysql.slave_master_info`（连接元数据仓库）
- 从 MySQL 8.0.19 开始：同时复制 `mysql.slave_relay_log_info`（执行器元数据）和 `mysql.slave_worker_info`（执行器工作线程元数据）





关于这些表内容详见 [第 19.2.4.2 节，复制元数据仓库](#19-2-4-2-replication-metadata-repositories)。

注意：若服务器配置为 `master_info_repository=FILE` 或 `relay_log_info_repository=FILE`（MySQL 8.0 默认不是此配置，且已弃用），则不会克隆元数据仓库，只有设置为 `TABLE` 时才会克隆。



------





### **克隆用于复制的步骤**







#### **对于组复制的新成员**





首先按照 [第 20.2.1.6 节，向组添加实例](#20-2-1-6-adding-instances-to-the-group) 配置 MySQL 实例用于组复制，并设置 [分布式恢复的克隆前提条件](#20-5-4-2-cloning-for-distributed-recovery)。



执行 START GROUP_REPLICATION 时，clone 操作将由组复制自动管理，无需手动操作，也无需进一步配置。





#### **对于主从复制拓扑中的副本**





1. 从 donor MySQL 实例手动将数据克隆到 recipient。donor 必须是拓扑中的 source 或 replica。

   具体操作见：[7.6.7.3 远程克隆数据](#7-6-7-3-cloning-remote-data)。

2. 克隆完成后，如果希望在 recipient 上继续使用与 donor 相同的复制通道，请验证哪些通道可以自动恢复，哪些需要手动设置。





------





### **使用 GTID 的复制**





- 如果 recipient 的 `gtid_mode=ON`，且从启用了 `gtid_mode=ON`、`ON_PERMISSIVE` 或 `OFF_PERMISSIVE` 的 donor 克隆，则 recipient 会继承 `gtid_executed`。
- 若 recipient 是从拓扑中已有的副本克隆而来，则启用 GTID 自动定位的通道可在克隆完成后自动恢复，无需手动配置。





------





### **使用二进制日志位置的复制**





- **MySQL 8.0.17 或 8.0.18**：recipient 不会应用 donor 的日志位置，仅记录于 `performance_schema.clone_status`。此类通道必须**手动配置**，且不要设置为开机自动启动。

- **MySQL 8.0.19 起**：recipient 会自动应用 donor 的日志位置。相关通道会尝试执行中继日志恢复流程，再重新启动复制：

  

  - **单线程副本**（`replica_parallel_workers = 0`）：若无其他问题，恢复通常可成功，复制自动恢复。
  - **多线程副本**（`replica_parallel_workers > 0`）：恢复可能失败并报错，需手动设置通道。

  





------





### **手动配置复制通道示例**







#### **使用 GTID 的拓扑**





配置 recipient 实例并添加通道（适用于 8.0.23 前后）：

```
-- MySQL 8.0.22 及以前版本
CHANGE MASTER TO MASTER_HOST='source_host_name', MASTER_PORT=source_port_num,
    MASTER_AUTO_POSITION=1 FOR CHANNEL 'setup_channel';
START SLAVE USER='user_name' PASSWORD='password' FOR CHANNEL 'setup_channel';

-- MySQL 8.0.22 和 8.0.23 起
CHANGE SOURCE TO SOURCE_HOST='source_host_name', SOURCE_PORT=source_port_num,
    SOURCE_AUTO_POSITION=1 FOR CHANNEL 'setup_channel';
START REPLICA USER='user_name' PASSWORD='password' FOR CHANNEL 'setup_channel';
```



------





#### **使用二进制日志位置的拓扑**





使用克隆操作中转移来的日志位置信息：

```
-- 获取日志位置信息
SELECT BINLOG_FILE, BINLOG_POSITION FROM performance_schema.clone_status;

-- MySQL 8.0.22 及以前版本
CHANGE MASTER TO MASTER_HOST='source_host_name', MASTER_PORT=source_port_num,
    MASTER_LOG_FILE='source_log_name', MASTER_LOG_POS=source_log_pos
    FOR CHANNEL 'setup_channel';
START SLAVE USER='user_name' PASSWORD='password' FOR CHANNEL 'setup_channel';

-- MySQL 8.0.22 和 8.0.23 起
CHANGE SOURCE TO SOURCE_HOST='source_host_name', SOURCE_PORT=source_port_num,
    SOURCE_LOG_FILE='source_log_name', SOURCE_LOG_POS=source_log_pos
    FOR CHANNEL 'setup_channel';
START REPLICA USER='user_name' PASSWORD='password' FOR CHANNEL 'setup_channel';
```