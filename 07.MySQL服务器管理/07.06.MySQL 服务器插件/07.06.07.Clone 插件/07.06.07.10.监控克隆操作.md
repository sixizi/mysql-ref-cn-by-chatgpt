

## **7.6.7.10 监控克隆操作（Monitoring Cloning Operations）**





本节介绍监控克隆操作的多个选项。





### **使用 Performance Schema Clone 表监控克隆操作**







#### **Monitoring Cloning Operations using Performance Schema Clone Tables**





克隆操作完成所需时间取决于数据量及迁移条件。



在 recipient 实例上，你可以使用 Performance Schema 中的 clone_status 和 clone_progress 表监控当前或最近一次克隆操作的状态和进度。



> **注意**：

> clone_status 和 clone_progress 表仅可用于监控 recipient 实例上的克隆操作。

> 若需在 donor 实例上监控操作，请参见“使用 Performance Schema 阶段事件监控克隆操作”。





- **clone_status** 表提供当前或最近一次克隆操作的状态：Not Started、In Progress、Completed 或 Failed。
- **clone_progress** 表按照阶段展示当前或最近一次克隆操作的进度，包括阶段如 DROP DATA、FILE COPY、PAGE_COPY、REDO_COPY、FILE_SYNC、RESTART、RECOVERY。





必须具有 Performance Schema 的 SELECT 和 EXECUTE 权限才能访问这些表。



**示例：检查克隆状态**

```
SELECT STATE FROM performance_schema.clone_status;
```

若克隆失败，可查询错误详情：

```
SELECT STATE, ERROR_NO, ERROR_MESSAGE FROM performance_schema.clone_status;
```

**示例：查看各阶段的状态与结束时间**

```
SELECT STAGE, STATE, END_TIME FROM performance_schema.clone_progress;
```



------





### **使用 Performance Schema 阶段事件监控克隆操作**







#### **Monitoring Cloning Operations Using Performance Schema Stage Events**





在 donor 或 recipient 上，都可启用阶段事件监控克隆操作进度。每个事件报告 WORK_COMPLETED 和 WORK_ESTIMATED，并随着进程推进而更新。



常用事件包括：



- **stage/innodb/clone (file copy)**：文件复制阶段，单位为文件块。
- **stage/innodb/clone (page copy)**：页面复制阶段，单位为页面。
- **stage/innodb/clone (redo copy)**：redo 日志复制阶段，单位为日志块。





**启用阶段事件监控示例**：

```
UPDATE performance_schema.setup_instruments 
SET ENABLED = 'YES' WHERE NAME LIKE 'stage/innodb/clone%';

UPDATE performance_schema.setup_consumers 
SET ENABLED = 'YES' WHERE NAME LIKE '%stages%';
```

然后执行克隆操作并查询当前事件：

```
SELECT EVENT_NAME, WORK_COMPLETED, WORK_ESTIMATED
FROM performance_schema.events_stages_current
WHERE EVENT_NAME LIKE 'stage/innodb/clone%';
```

若操作已完成，可在 events_stages_history 表中查看历史记录。



------





### **使用 Performance Schema 克隆性能检测工具监控**







#### **Monitoring Cloning Operations Using Performance Schema Clone Instrumentation**





Performance Schema 提供克隆操作的高级监控接口。可通过查询 performance_schema.setup_instruments 中 NAME LIKE '%clone%' 的项查看可用工具及启用状态。



常见的监控类别：



- **等待 (Wait) 工具**：如 clone_snapshot_mutex、clone_sys_mutex、clone_task_mutex、innodb_clone_file，用于跟踪互斥等待和 I/O 等待。
- **阶段 (Stage) 工具**：跟踪克隆操作的不同阶段（文件、redo、页面复制等）。
- **语句 (Statement) 工具**：如 statement/clone/local、statement/clone/client、statement/clone/server 等，用于监控克隆语句的执行情况。
- **内存 (Memory) 工具**：如 memory/innodb/clone、memory/clone/data，跟踪克隆期间的内存使用。





------





### **Com_clone**

###  **系统状态变量**





Com_clone 变量记录 CLONE 语句的执行次数。有关此类状态计数变量的详细说明，请参见第 7.1.10 节《服务器状态变量》。