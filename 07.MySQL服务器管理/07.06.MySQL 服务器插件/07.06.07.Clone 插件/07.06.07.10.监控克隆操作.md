#### 7.6.7.10 监控克隆操作

本节介绍监控克隆操作的多个选项。

- [使用 Performance Schema Clone 表监控克隆操作](#使用 Performance Schema Clone 表监控克隆操作)
- [使用 Performance Schema 阶段事件监控克隆操作](#使用 Performance Schema 阶段事件监控克隆操作)

- [使用 Performance Schema Clone 探针监控克隆操作](#使用 Performance Schema Clone 探针监控克隆操作)

##### 使用 Performance Schema Clone 表监控克隆操作

克隆操作的完成可能需要一段时间，具体取决于数据量及数据传输相关的其他因素。你可以通过 `Performance Schema` 中的 `clone_status` 和 `clone_progress` 表，在 recipient MySQL 服务器实例上监控克隆操作的状态和进度。

> **注意**：
>
> clone_status 和 clone_progress 表仅可用于监控 recipient 实例上的克隆操作。
>
> 若需在 donor 实例上监控操作，请参见“使用 Performance Schema 阶段事件监控克隆操作”。

- **clone_status** 表提供当前或最近一次克隆操作的状态：Not Started、In Progress、Completed 或 Failed。
- **clone_progress** 表按照阶段展示当前或最近一次克隆操作的进度，包括阶段如 `DROP DATA`、`FILE COPY`、`PAGE_COPY`、`REDO_COPY`、FILE_SYNC、`RESTART`、RECOVERY。

必须具有 Performance Schema 的 SELECT 和 EXECUTE 权限才能访问这些表。

检查克隆状态：

1. 连上recipient MySQL 实例：
2. 查询`clone_status`表：

    ```mysql
    mysql> SELECT STATE FROM performance_schema.clone_status;
    +-----------+
    | STATE     |
    +-----------+
    | Completed |
    +-----------+
    ```

若克隆失败，可查询错误详情：

```mysql
mysql> SELECT STATE, ERROR_NO, ERROR_MESSAGE FROM performance_schema.clone_status;
+-----------+----------+---------------+
| STATE     | ERROR_NO | ERROR_MESSAGE |
+-----------+----------+---------------+
| Failed    |      xxx | "xxxxxxxxxxx" |
+-----------+----------+---------------+
```

查看各阶段的状态与结束时间：

1. 连上recipient MySQL 实例：
2. 查询`clone_progress`表。例如，下面的查询提供克隆操作的每个阶段的状态和结束时间的数据：

```mysql
mysql> SELECT STAGE, STATE, END_TIME FROM performance_schema.clone_progress;
+-----------+-----------+----------------------------+
| stage     | state     | end_time                   |
+-----------+-----------+----------------------------+
| DROP DATA | Completed | 2019-01-27 22:45:43.141261 |
| FILE COPY | Completed | 2019-01-27 22:45:44.457572 |
| PAGE COPY | Completed | 2019-01-27 22:45:44.577330 |
| REDO COPY | Completed | 2019-01-27 22:45:44.679570 |
| FILE SYNC | Completed | 2019-01-27 22:45:44.918547 |
| RESTART   | Completed | 2019-01-27 22:45:48.583565 |
| RECOVERY  | Completed | 2019-01-27 22:45:49.626595 |
+-----------+-----------+----------------------------+
```

有关其他可监控的克隆状态和进度数据点，请参见 [第 29.12.19 节，Performance Schema Clone Tables](#29-12-19-performance-schema-clone-tables)。

##### 使用 Performance Schema 阶段事件监控克隆操作

克隆操作可能需要一定时间才能完成，具体取决于数据量和其他与数据传输相关的因素。你可以通过三种阶段事件（stage events）来监控克隆操作的进度。每个阶段事件都会报告 `WORK_COMPLETED` 和 `WORK_ESTIMATED` 的值，且这些值会随着操作进展而更新。

此监控方法适用于 donor 和 recipient MySQL 服务器实例。

克隆操作的阶段事件按发生顺序如下：

- `stage/innodb/clone (file copy)`：表示克隆操作中文件复制阶段的进度。`WORK_ESTIMATED` 和 `WORK_COMPLETED` 的单位为“文件块”。在文件复制阶段开始时，系统会知道需要传输多少文件，并根据文件数量估算出块数。`WORK_ESTIMATED` 被设置为估算出的文件块数量，`WORK_COMPLETED` 则在每传输一个块后更新。
- `stage/innodb/clone (page copy)`：表示克隆操作中页面复制阶段的进度。`WORK_ESTIMATED` 和 `WORK_COMPLETED` 的单位为“页”。在文件复制阶段完成后，系统会知道需要传输多少页，并将 `WORK_ESTIMATED` 设置为该数值。`WORK_COMPLETED` 在每发送一页后更新。
- `stage/innodb/clone (redo copy)`：表示克隆操作中 `redo` 日志复制阶段的进度。`WORK_ESTIMATED` 和 `WORK_COMPLETED` 的单位为 `redo` 块。在页面复制阶段完成后，系统会知道需要传输多少 `redo` 块，并将 `WORK_ESTIMATED` 设置为该值，`WORK_COMPLETED` 随每个块的发送而更新。

以下示例演示如何启用 stage/innodb/clone% 事件探针及相关消费表来监控克隆操作。关于 Performance Schema 阶段事件探针及消费者的更多信息，参见 [第 29.12.5 节，Performance Schema Stage Event Tables](#29-12-5-performance-schema-stage-event-tables)。

1. 启用阶段事件探针：

    ```mysql
    mysql> UPDATE performance_schema.setup_instruments SET ENABLED = 'YES'
           WHERE NAME LIKE 'stage/innodb/clone%';
    ```

2. 启用阶段事件消费者表（包括 `events_stages_current`、`events_stages_history` 和 `events_stages_history_long`）：

    ```mysql
    mysql> UPDATE performance_schema.setup_consumers SET ENABLED = 'YES'
           WHERE NAME LIKE '%stages%';
    ```

3. 执行克隆操作，例如将本地数据目录克隆到名为 cloned_dir 的目录中：

    ```mysql
    mysql> CLONE LOCAL DATA DIRECTORY = '/path/to/cloned_dir';
    ```

4. 查询克隆操作进度：

    ```mysql
    mysql> SELECT EVENT_NAME, WORK_COMPLETED, WORK_ESTIMATED
           FROM performance_schema.events_stages_current
           WHERE EVENT_NAME LIKE 'stage/innodb/clone%';
    +--------------------------------+----------------+----------------+
    | EVENT_NAME                     | WORK_COMPLETED | WORK_ESTIMATED |
    +--------------------------------+----------------+----------------+
    | stage/innodb/clone (redo copy) |              1 |              1 |
    +--------------------------------+----------------+----------------+
    ```


如果克隆操作已完成，`events_stages_current` 表将返回空集。此时你可以通过查询 `events_stages_history` 表查看已完成操作的事件数据。例如：

```mysql
mysql> SELECT EVENT_NAME, WORK_COMPLETED, WORK_ESTIMATED
       FROM events_stages_history
       WHERE EVENT_NAME LIKE 'stage/innodb/clone%';
+--------------------------------+----------------+----------------+
| EVENT_NAME                     | WORK_COMPLETED | WORK_ESTIMATED |
+--------------------------------+----------------+----------------+
| stage/innodb/clone (file copy) |            301 |            301 |
| stage/innodb/clone (page copy) |              0 |              0 |
| stage/innodb/clone (redo copy) |              1 |              1 |
+--------------------------------+----------------+----------------+
```

##### 使用 Performance Schema Clone 探针监控克隆操作

Performance Schema 提供了用于高级性能监控的克隆操作探针。要查看可用的克隆探针，可执行以下查询：

```mysql
mysql> SELECT NAME,ENABLED FROM performance_schema.setup_instruments
       WHERE NAME LIKE '%clone%';
+---------------------------------------------------+---------+
| NAME                                              | ENABLED |
+---------------------------------------------------+---------+
| wait/synch/mutex/innodb/clone_snapshot_mutex      | NO      |
| wait/synch/mutex/innodb/clone_sys_mutex           | NO      |
| wait/synch/mutex/innodb/clone_task_mutex          | NO      |
| wait/synch/mutex/group_rpl/LOCK_clone_donor_list  | NO      |
| wait/synch/mutex/group_rpl/LOCK_clone_handler_run | NO      |
| wait/synch/mutex/group_rpl/LOCK_clone_query       | NO      |
| wait/synch/mutex/group_rpl/LOCK_clone_read_mode   | NO      |
| wait/synch/cond/group_rpl/COND_clone_handler_run  | NO      |
| wait/io/file/innodb/innodb_clone_file             | YES     |
| stage/innodb/clone (file copy)                    | YES     |
| stage/innodb/clone (redo copy)                    | YES     |
| stage/innodb/clone (page copy)                    | YES     |
| statement/abstract/clone                          | YES     |
| statement/clone/local                             | YES     |
| statement/clone/client                            | YES     |
| statement/clone/server                            | YES     |
| memory/innodb/clone                               | YES     |
| memory/clone/data                                 | YES     |
+---------------------------------------------------+---------+
```

###### Wait Instruments

Performance Schema 等待探针用于追踪耗时事件。以下是克隆相关的等待事件探针：

- `wait/synch/mutex/innodb/clone_snapshot_mutex`：追踪 clone snapshot 互斥锁的等待事件，用于协调多个克隆线程对动态快照对象的访问（适用于 donor 和 recipient）。
- `wait/synch/mutex/innodb/clone_sys_mutex`：追踪 clone sys 互斥锁的等待事件，用于同步访问服务器实例中的克隆系统对象。
- `wait/synch/mutex/innodb/clone_task_mutex`：追踪克隆任务互斥锁的等待事件，用于任务管理。
- `wait/io/file/innodb/innodb_clone_file`：追踪克隆操作涉及文件的所有 I/O 等待操作。

详细内容请参见 [第 17.16.2 节，Monitoring InnoDB Mutex Waits Using Performance Schema](#17-16-2-monitoring-innodb-mutex-waits-using-performance-schema) 和 [第 29.12.4 节，Performance Schema Wait Event Tables](#29-12-4-performance-schema-wait-event-tables)。

###### Stage Instruments

Performance Schema 阶段事件用于追踪语句执行过程中的步骤。克隆相关的阶段事件探针包括：

- `stage/innodb/clone (file copy)`：表示文件复制阶段的进度。
- `stage/innodb/clone (redo copy)`：表示 redo 复制阶段的进度。
- `stage/innodb/clone (page copy)`：表示页面复制阶段的进度。

参见：[Monitoring Cloning Operations Using Performance Schema Stage Events](#monitoring-cloning-operations-using-performance-schema-stage-events) 和 [第 29.12.5 节，Performance Schema Stage Event Tables](#29-12-5-performance-schema-stage-event-tables)。

###### Statement Instruments

Performance Schema 语句事件用于追踪语句执行。在克隆操作开始时，不同类型的语句可能并行执行。执行数量受 `clone_max_concurrency` 和 `clone_autotune_concurrency` 的配置影响。克隆相关语句事件探针包括：

- `statement/abstract/clone`：追踪所有类型的克隆操作，尚未分类为 local、client 或 server 时。
- `statement/clone/local`：追踪本地克隆操作语句（执行 CLONE LOCAL 时生成）。
- `statement/clone/client`：追踪在 recipient 端执行 CLONE INSTANCE 时的远程克隆语句。
- `statement/clone/server`：追踪在 donor 端执行 CLONE INSTANCE 时的远程克隆语句。

参见：[第 29.12.6 节，Performance Schema Statement Event Tables](#29-12-6-performance-schema-statement-event-tables)。

###### Memory Instruments

Performance Schema 内存探针用于追踪内存使用。克隆相关内存使用探针包括：

- `memory/innodb/clone`：追踪 InnoDB 为动态快照分配的内存。
- `memory/clone/data`：追踪克隆插件在克隆过程中分配的内存。

参见：[第 29.12.20.10 节，Memory Summary Tables](#29-12-20-10-memory-summary-tables)。

###### Com_clone状态变量

`Com_clone` 状态变量用于统计 `CLONE` 语句的执行次数。

更多信息参见 [第 7.1.10 节，Server Status Variables](#7-1-10-server-status-variables) 中对 Com_xxx 语句计数变量的讨论。