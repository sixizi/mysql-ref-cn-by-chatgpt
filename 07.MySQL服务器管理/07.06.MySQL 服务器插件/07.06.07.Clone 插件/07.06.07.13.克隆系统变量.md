#### 7.6.7.13 克隆系统变量

本节介绍用于控制 clone 插件操作的一系列系统变量。如果启动时指定的值不正确，clone 插件可能无法正确初始化，服务器将不会加载它，并可能因不识别其他克隆设置而输出错误信息。

每个系统变量都有一个 **默认值**。可以在服务器启动时通过命令行或配置文件设置系统变量。也可在运行时使用 SET 语句动态更改，从而修改服务器行为，无需重启服务器。

通常修改全局系统变量需具备 `SYSTEM_VARIABLES_ADMIN`（或已弃用的 `SUPER`）权限，并且变量设置在执行克隆操作所在的 recipient MySQL 实例上。

- **clone_autotune_concurrency**

    | **属性**          | **值**                       |
    | ----------------- | ---------------------------- |
    | 命令行格式        | --clone-autotune-concurrency |
    | 引入版本          | 8.0.17                       |
    | 系统变量          | clone_autotune_concurrency   |
    | 作用域            | Global                       |
    | 动态修改          | Yes                          |
    | 支持 SET_VAR Hint | No                           |
    | 类型              | Boolean                      |
    | 默认值            | ON                           |

    当启用 `clone_autotune_concurrency`（默认启用）时，远程克隆操作会动态生成额外的线程以优化数据传输速度。该设置仅适用于 recipient MySQL 服务器实例。

    在克隆操作期间，线程数会逐步增加，目标是当前线程数的两倍。每次递增后都会评估数据传输速度的变化，根据以下规则决定是否继续：

    - 如果传输速度下降超过 5%，则停止线程增加；

    - 如果在达到目标的 25% 时提升至少 5%，继续增加线程，否则停止；

    - 如果在达到目标的 50% 时提升至少 10%，继续增加线程，否则停止；

    - 如果在达到目标时提升至少 25%，将新目标设为当前线程数的两倍并继续增加线程，否则停止。

    自动调优过程**不支持减少线程数量**。

    最大可生成线程数由 `clone_max_concurrency` 变量定义；

    若禁用 clone_autotune_concurrency，则远程克隆操作会直接使用 `clone_max_concurrency` 指定的线程数量。

- **clone_buffer_size**

    | **属性**          | **值**               |
    | ----------------- | -------------------- |
    | 命令行格式        | --clone-buffer-size  |
    | 引入版本          | 8.0.17               |
    | 系统变量          | clone_buffer_size    |
    | 作用域            | Global               |
    | 动态修改          | Yes                  |
    | 支持 SET_VAR Hint | No                   |
    | 类型              | Integer              |
    | 默认值            | 4194304（4 MiB）     |
    | 最小值            | 1048576（1 MiB）     |
    | 最大值            | 268435456（256 MiB） |
    | 单位              | bytes                |

    定义本地克隆操作中用于传输数据的中间缓冲区大小。默认值为 4 MiB。增大缓冲区大小可能允许 I/O 设备驱动并行抓取数据，从而提升克隆性能。

- **clone_block_ddl**

    | **属性**          | **值**            |
    | ----------------- | ----------------- |
    | 命令行格式        | --clone-block-ddl |
    | 引入版本          | 8.0.27            |
    | 系统变量          | clone_block_ddl   |
    | 作用域            | Global            |
    | 动态修改          | Yes               |
    | 支持 SET_VAR Hint | No                |
    | 类型              | Boolean           |
    | 默认值            | OFF               |

    在克隆操作期间，在 donor MySQL 服务器实例上启用独占的备份锁，从而阻止并发执行的 DDL 操作。参见 [第 7.6.7.4 节，“Cloning and Concurrent DDL”](#7-6-7-4-cloning-and-concurrent-ddl)。

- **clone_delay_after_data_drop**

    | **属性**          | **值**                        |
    | ----------------- | ----------------------------- |
    | 命令行格式        | --clone-delay-after-data-drop |
    | 引入版本          | 8.0.29                        |
    | 系统变量          | clone_delay_after_data_drop   |
    | 作用域            | Global                        |
    | 动态修改          | Yes                           |
    | 支持 SET_VAR Hint | No                            |
    | 类型              | Integer                       |
    | 默认值            | 0                             |
    | 最小值            | 0                             |
    | 最大值            | 3600                          |
    | 单位              | seconds                       |

    指定在远程克隆操作开始时，从 recipient MySQL 服务器实例移除现有数据后等待的延迟时间。此延迟是为了让 recipient 主机上的文件系统有充足时间释放空间，然后再从 donor 克隆数据。某些文件系统（如 VxFS）采用异步后台进程释放空间，若过早开始克隆可能因空间不足而失败。最长延迟为 3600 秒（1 小时），默认值为 0（无延迟）。该变量仅适用于远程克隆操作，并应在 recipient MySQL 服务器实例上配置。

- **clone_ddl_timeout**

    | **属性**          | **值**              |
    | ----------------- | ------------------- |
    | 命令行格式        | --clone-ddl-timeout |
    | 引入版本          | 8.0.17              |
    | 系统变量          | clone_ddl_timeout   |
    | 作用域            | Global              |
    | 动态修改          | Yes                 |
    | 支持 SET_VAR Hint | No                  |
    | 类型              | Integer             |
    | 默认值            | 300                 |
    | 最小值            | 0                   |
    | 最大值            | 2592000             |
    | 单位              | seconds             |

    指定克隆操作在等待 backup lock（备份锁）时的最长秒数。该锁用于阻止克隆期间的并发 DDL 操作。此设置适用于 donor 和 recipient MySQL 实例。

    设置为 0 表示克隆操作不会等待 backup lock，此时若有并发 DDL，克隆可能失败。

    在 MySQL 8.0.27 之前，克隆操作必须等待 donor 和 recipient 上的所有并发 DDL 完成；从 8.0.27 起，如果 clone_block_ddl=OFF（默认），donor 端允许并发 DDL，则无需等待锁。详见：[7.6.7.4 Cloning and Concurrent DDL](#7-6-7-4-cloning-and-concurrent-ddl)

- **clone_donor_timeout_after_network_failure**

    | **属性**          | **值**                                      |
    | ----------------- | ------------------------------------------- |
    | 命令行格式        | --clone-donor-timeout-after-network-failure |
    | 引入版本          | 8.0.24                                      |
    | 系统变量          | clone_donor_timeout_after_network_failure   |
    | 作用域            | Global                                      |
    | 动态修改          | Yes                                         |
    | 支持 SET_VAR Hint | No                                          |
    | 类型              | Integer                                     |
    | 默认值            | 5                                           |
    | 最小值            | 0                                           |
    | 最大值            | 30                                          |
    | 单位              | minutes                                     |

    定义在发生网络故障后，donor MySQL 实例允许 recipient 重新连接并恢复克隆操作的最长等待时间（以分钟为单位）。更多信息参见：[7.6.7.9 Remote Cloning Operation Failure Handling](#7-6-7-9-remote-cloning-operation-failure-handling)。

    此变量应设置在 donor MySQL 实例上，在 recipient 实例上设置无效。

- **clone_enable_compression**

    | **属性**          | **值**                     |
    | ----------------- | -------------------------- |
    | 命令行格式        | --clone-enable-compression |
    | 引入版本          | 8.0.17                     |
    | 系统变量          | clone_enable_compression   |
    | 作用域            | Global                     |
    | 动态修改          | Yes                        |
    | 支持 SET_VAR Hint | No                         |
    | 类型              | Boolean                    |
    | 默认值            | OFF                        |

    在远程克隆操作期间启用网络层数据压缩。压缩可以节省网络带宽，但会消耗更多 CPU 资源。启用压缩可能提升数据传输速率。此设置仅适用于 recipient MySQL 服务器实例。

- **clone_max_concurrency**

    | **属性**          | **值**                  |
    | ----------------- | ----------------------- |
    | 命令行格式        | --clone-max-concurrency |
    | 引入版本          | 8.0.17                  |
    | 系统变量          | clone_max_concurrency   |
    | 作用域            | Global                  |
    | 动态修改          | Yes                     |
    | 支持 SET_VAR Hint | No                      |
    | 类型              | Integer                 |
    | 默认值            | 16                      |
    | 最小值            | 1                       |
    | 最大值            | 128                     |
    | 单位              | threads                 |

    定义远程克隆操作中允许的最大并发线程数。默认值为 16。较大的线程数可以提高克隆性能，但会减少允许的同时客户端连接数，可能影响现有连接的性能。此设置仅适用于 recipient MySQL 服务器实例。

    如果启用了 `clone_autotune_concurrency`（默认开启），则 `clone_max_concurrency` 是远程克隆操作中可以动态生成的最大线程数。如果禁用了 `clone_autotune_concurrency`，则 `clone_max_concurrency` 定义了远程克隆操作中实际生成的线程数。

    建议远程克隆操作中每个线程的最小数据传输速率为 1 MiB。数据传输速率由 `clone_max_data_bandwidth` 变量控制。

- **clone_max_data_bandwidth**

    | **属性**          | **值**                     |
    | ----------------- | -------------------------- |
    | 命令行格式        | --clone-max-data-bandwidth |
    | 引入版本          | 8.0.17                     |
    | 系统变量          | clone_max_data_bandwidth   |
    | 作用域            | Global                     |
    | 动态修改          | Yes                        |
    | 支持 SET_VAR Hint | No                         |
    | 类型              | Integer                    |
    | 默认值            | 0                          |
    | 最小值            | 0                          |
    | 最大值            | 1048576                    |
    | 单位              | MiB/second                 |

    定义远程克隆操作中每秒最大数据传输速率（以 MiB 为单位）。该变量用于管理克隆操作对性能的影响。仅当 donor 的磁盘 I/O 带宽饱和、影响性能时，才建议设置上限。设置为 0 表示“无限制”，允许以最高速率进行克隆操作。此设置仅适用于 recipient MySQL 服务器实例。

    每个线程的最小数据传输速率为 1 MiB/秒，例如有 8 个线程，则最小传输速率为 8 MiB/秒。线程数量由 `clone_max_concurrency` 控制。

    实际传输速率可能与 `clone_max_data_bandwidth` 指定值不同，实际速率可通过 `performance_schema.clone_progress` 表中的 DATA_SPEED 列查看。如果实际速率未达到期望值，且带宽充足，请检查 recipient 和 donor 的 I/O 使用情况。若带宽未饱和，则 I/O 很可能是性能瓶颈。

- **clone_max_network_bandwidth**

    | **属性**          | **值**                        |
    | ----------------- | ----------------------------- |
    | 命令行格式        | --clone-max-network-bandwidth |
    | 引入版本          | 8.0.17                        |
    | 系统变量          | clone_max_network_bandwidth   |
    | 作用域            | Global                        |
    | 动态修改          | Yes                           |
    | 支持 SET_VAR Hint | No                            |
    | 类型              | Integer                       |
    | 默认值            | 0                             |
    | 最小值            | 0                             |
    | 最大值            | 1048576                       |
    | 单位              | MiB/second                    |

    指定远程克隆操作中每秒最大近似网络传输速率（以 MiB 为单位）。可用于控制克隆操作对网络带宽的性能影响。仅在网络带宽饱和、影响 donor 实例性能时建议设置上限。设置为 0 表示“无限制”，允许以最高网络速率进行克隆，提供最佳性能。此设置仅适用于 recipient MySQL 服务器实例。

- **clone_ssl_ca**

    | **属性**          | **值**                   |
    | ----------------- | ------------------------ |
    | 命令行格式        | --clone-ssl-ca=file_name |
    | 引入版本          | 8.0.14                   |
    | 系统变量          | clone_ssl_ca             |
    | 作用域            | Global                   |
    | 动态修改          | Yes                      |
    | 支持 SET_VAR Hint | No                       |
    | 类型              | File name                |
    | 默认值            | 空字符串                 |

    指定证书颁发机构（CA）文件的路径。用于配置远程克隆操作中的加密连接。此设置应配置在 recipient 上，用于连接 donor。

- **clone_ssl_cert**

    | **属性**          | **值**                     |
    | ----------------- | -------------------------- |
    | 命令行格式        | --clone-ssl-cert=file_name |
    | 引入版本          | 8.0.14                     |
    | 系统变量          | clone_ssl_cert             |
    | 作用域            | Global                     |
    | 动态修改          | Yes                        |
    | 支持 SET_VAR Hint | No                         |
    | 类型              | File name                  |
    | 默认值            | 空字符串                   |

    指定公钥证书文件的路径。用于配置远程克隆操作中的加密连接。此设置应配置在 recipient 上，用于连接 donor。

- **clone_ssl_key**

    | **属性**          | **值**                    |
    | ----------------- | ------------------------- |
    | 命令行格式        | --clone-ssl-key=file_name |
    | 引入版本          | 8.0.14                    |
    | 系统变量          | clone_ssl_key             |
    | 作用域            | Global                    |
    | 动态修改          | Yes                       |
    | 支持 SET_VAR Hint | No                        |
    | 类型              | File name                 |
    | 默认值            | 空字符串                  |

    指定私钥文件的路径。用于配置远程克隆操作中的加密连接。此设置应配置在 recipient 上，用于连接 donor。

- **clone_valid_donor_list**

    | **属性**          | **值**                         |
    | ----------------- | ------------------------------ |
    | 命令行格式        | --clone-valid-donor-list=value |
    | 引入版本          | 8.0.17                         |
    | 系统变量          | clone_valid_donor_list         |
    | 作用域            | Global                         |
    | 动态修改          | Yes                            |
    | 支持 SET_VAR Hint | No                             |
    | 类型              | String                         |
    | 默认值            | NULL                           |

    定义远程克隆操作中允许的有效 donor 主机地址。该设置应用于 recipient MySQL 服务器实例。支持以逗号分隔的格式指定多个主机地址和端口："`HOST1:PORT1,HOST2:PORT2,HOST3:PORT3`"（不允许包含空格）。

    该变量添加了一层安全控制，用于限制数据克隆来源。配置该变量需要 `SYSTEM_VARIABLES_ADMIN` 权限，而执行远程克隆操作则需 CLONE_ADMIN 权限，可将两项职责分配给不同角色。

    注意：不支持 IPv6 地址格式，可以使用 IPv6 地址的别名或使用 IPv4 地址。