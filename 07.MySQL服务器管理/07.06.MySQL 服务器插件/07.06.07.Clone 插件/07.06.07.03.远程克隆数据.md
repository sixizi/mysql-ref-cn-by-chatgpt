

#### 7.6.7.3 远程克隆数据

clone 插件支持以下语法，用于从远程 MySQL 实例（donor）克隆数据到发起克隆操作的 MySQL 实例（recipient）：

```mysql
CLONE INSTANCE FROM 'user'@'host':port
IDENTIFIED BY 'password'
[DATA DIRECTORY [=] 'clone_dir']
[REQUIRE [NO] SSL];
```

- **user**：donor 上用于克隆的用户。
- **password**：该用户的密码。
- **host**：donor 的主机地址，不支持 IPv6 格式，但可以通过 IPv6 别名使用；IPv4 地址可以直接使用。
- **port**：donor 实例的 MySQL 端口。不支持 X Protocol 端口（mysqlx_port），也不支持通过 MySQL Router 连接。
- **DATA DIRECTORY [=] 'clone_dir**'：可选；指定 recipient 上存放克隆数据的目录。使用该选项可避免删除 recipient 上现有的用户数据和二进制日志。必须为绝对路径，目标目录不能已存在，MySQL 必须有权限创建它。
- **REQUIRE [NO] SSL**：显式指定是否使用加密连接。若未指定，默认尝试使用加密连接，失败后降级为不安全连接。若克隆加密数据，则无论是否指定此子句，都 **必须** 使用加密连接。

> **注意**
>
> 默认情况下，位于 donor 数据目录中的用户自建 InnoDB 表和表空间会克隆到 recipient 的数据目录；指定 DATA DIRECTORY 时，它们将克隆到该指定目录。
>
> 位于数据目录之外的用户表或表空间会按相同路径克隆到 recipient 上，如目标路径已存在则报错。
>
> 默认情况下，InnoDB 系统表空间、redo logs 和 undo tablespaces 默认克隆到 donor 上的相应位置（由 `innodb_data_home_dir`、`innodb_data_file_path`、`innodb_log_group_home_dir` 和 `innodb_undo_directory` 配置）。若使用 DATA DIRECTORY，则这些也会一并克隆到指定目录。

##### 远程克隆的前提条件

要执行克隆操作，clone 插件必须在 donor 和 recipient 的 MySQL 服务器实例中都处于激活状态。有关安装说明，请参见 [第 7.6.7.1 节，安装 Clone 插件](#7-6-7-1-installing-the-clone-plugin)。

在 donor 和 recipient 上都需要创建一个用于执行克隆操作的 `MySQL` 用户（即 “克隆用户”）。

- 在 donor 上，该用户必须具有 `BACKUP_ADMIN` 权限，以便访问并传输数据，以及在克隆期间阻止并发 `DDL` 操作。

  在 MySQL 8.0.27 之前，克隆过程中默认会阻止并发 `DDL`；从 8.0.27 起，默认允许并发 `DDL`。参见 [第 7.6.7.4 节，克隆与并发 DDL](#7-6-7-4-cloning-and-concurrent-ddl)。

- 在 recipient 上，该用户必须具有 `CLONE_ADMIN` 权限，用于替换数据、在克隆期间阻止 DDL 操作，并自动重启服务器。

  `CLONE_ADMIN` 权限隐含 `BACKUP_ADMIN` 和 `SHUTDOWN` 权限。

创建克隆用户并授予权限的说明见随后提供的远程克隆示例。

当执行 `CLONE INSTANCE` 语句时，会检查以下前提条件：

- clone 插件在 MySQL 8.0.17 及更高版本中受支持。donor 和 recipient 必须属于相同的 MySQL 系列版本（例如 8.0.37 和 8.0.41）。对于 8.0.37 之前的版本，它们还必须是相同的小版本。

  ```mysql
  mysql> SHOW VARIABLES LIKE 'version';
  +---------------+--------+
  | Variable_name | Value  |
  +---------------+--------+
  | version       | 8.0.43 |
  +---------------+--------+
  ```

  从 MySQL 8.0.26 开始，支持从 donor 克隆到相同版本和发行号的 hotfix 实例。

  从 MySQL 8.0.37 起，支持跨小版本的克隆。对于早于 8.0.37 的版本，仍适用旧的限制，例如不允许从 8.0.36 克隆到 8.0.42 或反向克隆。

- donor 和 recipient 必须运行在相同的操作系统与平台上。例如，如果 donor 是 Linux 64 位平台，recipient 也必须是该平台。具体平台信息请参考操作系统文档。

- recipient 必须具有足够的磁盘空间来容纳克隆数据。默认情况下，recipient 会先清除其上现有的用户数据和 binary logs，因此只需存储来自 donor 的数据即可。如果使用 DATA DIRECTORY 子句克隆到命名目录，则需同时容纳原始数据和克隆数据。可以通过检查文件系统中的数据目录大小和位于数据目录之外的表空间大小来估算数据容量。注意，克隆仅包括 InnoDB 数据；如使用其他存储引擎，请适当调整估算值。

- InnoDB 允许将某些类型的表空间创建在数据目录之外。如果 donor 存在此类表空间，克隆操作必须能访问这些表空间。

  可通过以下语句查询位于数据目录之外的表空间：

  ```mysql
  mysql> SELECT FILE_NAME FROM INFORMATION_SCHEMA.FILES;
  ```

- 在 donor 上激活的插件（如 `keyring` 插件）必须在 recipient 上也处于激活状态。

  可使用 `SHOW PLUGINS` 或查询 `INFORMATION_SCHEMA.PLUGINS` 获取插件状态。

- donor 和 recipient 必须使用相同的 MySQL 字符集和校对规则。配置参考见 [第 12.15 节，字符集配置](#12-15-character-set-configuration)。

- donor 和 recipient 的 `innodb_page_size` 和 `innodb_data_file_path` 设置必须相同，并且数据文件数量及大小一致。检查方法如下：

  ```mysql
  mysql> SHOW VARIABLES LIKE 'innodb_page_size';
  mysql> SHOW VARIABLES LIKE 'innodb_data_file_path';
  ```

- 如果要克隆加密数据或压缩页数据，donor 和 recipient 的文件系统块大小必须一致。若为压缩页数据，recipient 的文件系统还必须支持稀疏文件和 hole punching。更多信息及识别方式，请参见 [第 7.6.7.5 节，克隆加密数据](#7-6-7-5-cloning-encrypted-data) 和 [第 7.6.7.6 节，克隆压缩数据](#7-6-7-6-cloning-compressed-data)。

- 若克隆加密数据，则必须使用加密连接。参见 *配置克隆的加密连接（Configuring an Encrypted Connection for Cloning）*。

- recipient 上的 clone_valid_donor_list 设置必须包含 donor 的主机地址。只能从该列表中的主机克隆数据。设置该变量需要具有 SYSTEM_VARIABLES_ADMIN 权限。可使用以下语句检查当前值：

  ```mysql
  mysql> SHOW VARIABLES LIKE 'clone_valid_donor_list';
  ```

- 克隆过程中不能有其他克隆操作正在运行。每次只能进行一个克隆操作。可通过 clone_status 表判断是否存在正在进行的操作。参见 *使用 Performance Schema 监控克隆操作（Monitoring Cloning Operations using Performance Schema Clone Tables）*。

- clone 插件以每包 1MB 的数据传输加上元数据。因此，donor 和 recipient 上 max_allowed_packet 的最小值为 2MB。否则会出错。可使用以下命令检查设置：

  ```mysql
  mysql> SHOW VARIABLES LIKE 'max_allowed_packet';
  ```

其他前提条件：

- donor 上的 undo 表空间文件名必须唯一。克隆时，这些文件将被复制到 recipient 的 innodb_undo_directory，或 DATA DIRECTORY 指定的目录中。如果文件名重复，可能会导致覆盖。从 MySQL 8.0.18 起，遇到重复将报错；之前版本可能会出现覆盖。

  可使用以下语句确认文件名唯一性：

  ```mysql
  mysql> SELECT TABLESPACE_NAME, FILE_NAME FROM INFORMATION_SCHEMA.FILES
         WHERE FILE_TYPE LIKE 'UNDO LOG';
  ```

	删除和添加 undo 表空间文件的更多信息，请参见 [第 17.6.3.4 节，Undo 表空间](#17-6-3-4-undo-tablespaces)。

- 默认情况下，recipient 实例在克隆完成后会自动重启（先关闭再启动）。自动重启要求 recipient 上有可检测服务器关闭的监控进程。否则，克隆完成后会报错：

  ```
  ERROR 3707 (HY000): Restart server failed (mysqld is not managed by supervisor process).
  ```
	此错误不代表克隆失败，而是提示你需要手动重启 recipient 实例。手动重启后，你可以连接并通过 Performance Schema 的 clone 表验证克隆是否成功完成。RESTART 语句同样需要监控进程支持。参见 [第 15.7.8.8 节，RESTART 语句](#15-7-8-8-restart-statement)。如果使用了 DATA DIRECTORY 克隆到命名目录，则不适用自动重启机制。

- 多个变量控制远程克隆的各个方面。在执行之前，应查看这些变量，并根据实际情况进行配置。

  克隆相关变量在 recipient 实例上设置。详见 [第 7.6.7.13 节，克隆系统变量](#7-6-7-13-clone-system-variables)。

##### 克隆远程数据

以下示例演示了如何克隆远程数据。默认情况下，远程克隆操作会删除 recipient 上用户创建的数据（schemas、tables、tablespaces）和 binary logs，将新的数据克隆到 recipient 的数据目录中，并在之后重启 MySQL 服务器。

本示例假设已满足远程克隆的前提条件。参见 *Remote Cloning Prerequisites*。

1. 使用管理员用户账号登录到 donor MySQL 服务器实例。
   1. 创建一个具有 BACKUP_ADMIN 权限的克隆用户。

    ```mysql
    mysql> CREATE USER 'donor_clone_user'@'example.donor.host.com' IDENTIFIED BY 'password';
    mysql> GRANT BACKUP_ADMIN on *.* to 'donor_clone_user'@'example.donor.host.com';
    ```

   2. 安装 clone 插件：   

    ```mysql
    mysql> INSTALL PLUGIN clone SONAME 'mysql_clone.so';
    ```

2. 使用管理员用户账号登录到 recipient MySQL 服务器实例。

   1. 创建一个具有 CLONE_ADMIN 权限的克隆用户。

    ```mysql
    mysql> CREATE USER 'recipient_clone_user'@'example.recipient.host.com' IDENTIFIED BY 'password';
    mysql> GRANT CLONE_ADMIN on *.* to 'recipient_clone_user'@'example.recipient.host.com';
    ```

   2.安装 clone 插件：

    ```mysql
    mysql> INSTALL PLUGIN clone SONAME 'mysql_clone.so';
	 ```

   3.将 donor MySQL 服务器实例的主机地址添加到 clone_valid_donor_list 变量设置中：

    ```mysql
    mysql> SET GLOBAL clone_valid_donor_list = 'example.donor.host.com:3306';
    ```

3. 以你之前创建的克隆用户（recipient_clone_user'@'example.recipient.host.com）登录到 recipient MySQL 服务器实例并执行 CLONE INSTANCE 语句：

    ```mysql
    mysql> CLONE INSTANCE FROM 'donor_clone_user'@'example.donor.host.com':3306
           IDENTIFIED BY 'password';
    ```
    数据克隆完成后，recipient 上的 MySQL 服务器实例将自动重启。

  有关监控克隆操作状态和进度的信息，请参见 [第 7.6.7.10 节，“监控克隆操作”](#7-6-7-10-monitoring-cloning-operations)。

##### 克隆到命名目录

默认情况下，远程克隆操作会在从 donor MySQL 服务器实例克隆数据之前，删除 recipient 数据目录中的用户创建的数据（schemas、tables、tablespaces）和 binary logs。通过将数据克隆到命名目录，你可以避免删除当前 recipient 数据目录中的数据。

克隆到命名目录的流程与“克隆远程数据”中描述的流程相同，只有一个例外：CLONE INSTANCE 语句必须包含 DATA DIRECTORY 子句。例如：

  ```mysql
mysql> CLONE INSTANCE FROM 'user'@'example.donor.host.com':3306
       IDENTIFIED BY 'password'
       DATA DIRECTORY = '/path/to/clone_dir';
  ```

必须提供绝对路径，且该目录不能已存在。MySQL 服务器必须具有创建该目录所需的写访问权限。

当克隆到命名目录时，数据克隆完成后 recipient MySQL 服务器实例不会自动重启。如果你希望在命名目录上重新启动 MySQL 服务器，必须手动执行：

```mysql
$> mysqld_safe --datadir=/path/to/clone_dir
```

其中，/path/to/clone_dir 是 recipient 上命名目录的路径。

##### 配置克隆的加密连接

你可以为远程克隆操作配置加密连接，以在网络传输过程中保护数据。当克隆加密数据时，**默认要求使用加密连接**（参见 [第 7.6.7.5 节，克隆加密数据](#7-6-7-5-cloning-encrypted-data)）。

下列说明介绍了如何配置 recipient MySQL 服务器实例以使用加密连接。假设 donor 实例已配置好加密连接。如果尚未配置，请参见 [第 8.3.1 节，配置 MySQL 使用加密连接](#8-3-1-configuring-mysql-to-use-encrypted-connections)。

要将接收方 MySQL 服务器实例配置为使用加密连接：

1. 将 donor MySQL 实例的客户端证书和密钥文件提供给 recipient 主机。可通过安全通道传输文件到 recipient，或将它们放置在 recipient 可访问的挂载分区中。需要提供以下客户端证书和密钥文件：

   - `ca.pem`

     自签名的证书颁发机构（CA）文件

   - `client-cert.pem`

     客户端公钥证书文件

   - `client-key.pem`

     客户端私钥文件

2. 在 recipient MySQL 服务器实例上配置以下 SSL 选项：

   - `clone_ssl_ca`

     指定 CA 文件路径

   - `clone_ssl_cer`

     指定客户端公钥证书文件路径

   - `clone_ssl_key`

     指定客户端私钥文件路径

   示例配置如下：

    ```ini
    clone_ssl_ca=/path/to/ca.pem
    clone_ssl_cert=/path/to/client-cert.pem
    clone_ssl_key=/path/to/client-key.pem
    ```

3. 若你希望强制使用加密连接，在 recipient 执行 CLONE 语句时添加 REQUIRE SSL 子句：

    ```mysql
    mysql> CLONE INSTANCE FROM 'user'@'example.donor.host.com':3306
             IDENTIFIED BY 'password'
             DATA DIRECTORY = '/path/to/clone_dir'
             REQUIRE SSL;
    ```

    如果未指定 SSL 子句，clone 插件将默认尝试建立加密连接；如果失败，则会回退到非加密连接。

    > **注意**
    >
    > 如果你正在克隆加密数据，则无论是否指定 `REQUIRE SSL`，**默认都必须使用加密连接**。
    >
    > 如果尝试使用 REQUIRE NO SSL 克隆加密数据，将导致错误。