

## **7.6.7.3 远程克隆数据**





clone 插件支持以下语法，用于从远程 MySQL 实例（donor）克隆数据到发起克隆操作的 MySQL 实例（recipient）：

```
CLONE INSTANCE FROM 'user'@'host':port
IDENTIFIED BY 'password'
[DATA DIRECTORY [=] 'clone_dir']
[REQUIRE [NO] SSL];
```



- user：donor 上用于克隆的用户。
- password：该用户的密码。
- host：donor 的主机地址，不支持 IPv6 格式，但可以通过 IPv6 别名使用；IPv4 地址可以直接使用。
- port：donor 实例的 MySQL 端口。不支持 X Protocol 端口（mysqlx_port），也不支持通过 MySQL Router 连接。
- DATA DIRECTORY [=] 'clone_dir'：可选；指定 recipient 上存放克隆数据的目录。使用该选项可避免删除 recipient 上现有的用户数据和二进制日志。必须为绝对路径，目标目录不能已存在，MySQL 必须有权限创建它。
- REQUIRE [NO] SSL：显式指定是否使用加密连接。若未指定，默认尝试使用加密连接，失败后降级为不安全连接。若克隆加密数据，则无论是否指定此子句，都 **必须** 使用加密连接。





> **注意**

> 默认情况下，位于 donor 数据目录中的用户自建 InnoDB 表和表空间会克隆到 recipient 的数据目录；指定 DATA DIRECTORY 时，它们将克隆到该指定目录。

> 位于数据目录之外的用户表或表空间会按相同路径克隆到 recipient 上，如目标路径已存在则报错。



InnoDB 系统表空间、redo logs 和 undo tablespaces 默认克隆到 donor 上的相应位置（由 innodb_data_home_dir、innodb_data_file_path、innodb_log_group_home_dir 和 innodb_undo_directory 配置）。若使用 DATA DIRECTORY，则这些也会一并克隆到指定目录。



------





### **远程克隆前提条件**





- clone 插件必须在 donor 和 recipient 上均已启用（详见 [7.6.7.1 节](#7-6-7-1-installing-the-clone-plugin)）。
- donor 上的 clone 用户需具备 BACKUP_ADMIN 权限，以阻止并发 DDL（MySQL 8.0.27 之前为默认阻止；8.0.27 及以后版本默认允许并发 DDL）（见 [7.6.7.4 节](#7-6-7-4-cloning-and-concurrent-ddl)）。
- recipient 上的 clone 用户需具备 CLONE_ADMIN 权限（其中隐含 BACKUP_ADMIN 和 SHUTDOWN 权限）。
- donor 和 recipient 必须运行 **相同系列**（如同属 8.0.x），**8.0.37 之前还要求相同点版本**；自 8.0.26 起支持 hotfix 版本的克隆；从 8.0.37 起允许不同点版本之间克隆 #。
- donor 和 recipient 必须运行相同操作系统与平台（如都是 Linux 64 位）。
- recipient 必须有足够磁盘空间：若未使用 DATA DIRECTORY，只需足够存放 donor 数据；若使用了该选项，则需空间存放 recipient 原数据 + donor 克隆数据。
- donor 上任何位于数据目录外的表空间必须可被访问（可用 INFORMATION_SCHEMA.FILES 查询）。
- donor 上激活的插件（例如 keyring 插件）必须在 recipient 上同时激活（可通过 SHOW PLUGINS 或查询 INFORMATION_SCHEMA.PLUGINS 验证）。
- donor 和 recipient 的字符集与排序规则必须一致（参见 〔12.15 节〕字符集配置）。
- innodb_page_size 和 innodb_data_file_path 设置必须一致：数据文件数量与大小需相符。
- 若克隆加密或页压缩数据，donor 和 recipient 文件系统块大小必须相同；克隆压缩表空间时，recipient 文件系统需支持稀疏文件与 hole‑punching。
- 若克隆加密数据，必须使用加密连接。
- recipient 的 clone_valid_donor_list 必须包含 donor 的 host 地址（需要 SYSTEM_VARIABLES_ADMIN 权限设置；可 SHOW VARIABLES LIKE 'clone_valid_donor_list' 检查）。
- 同一时间只允许执行一个克隆操作（可查询 Performance Schema clone 状态表确认）。
- max_allowed_packet 必须 ≥ 2 MB（在 donor 和 recipient 上均需满足）。
- donor 上 undo tablespace 文件名必须唯一；MySQL 8.0.18 后若有重复，会报错；升级前版本可能导致覆盖。可通过：



```
SELECT TABLESPACE_NAME, FILE_NAME 
  FROM INFORMATION_SCHEMA.FILES 
 WHERE FILE_TYPE LIKE 'UNDO LOG';
```



- 
- recipient 在默认情况下完成克隆后会自动重启（需有监控进程）；若未检测到监控器，则会报错 ERROR 3707 (HY000): Restart server failed (mysqld is not managed by supervisor process)，需手动启动 MySQL。使用 DATA DIRECTORY 时则不会自动重启。
- 可通过设置各种 clone 系列系统变量（见 [7.6.7.13 节](#7-6-7-13-clone-system-variables)）调整 remote cloning 行为。





------





### **示例：远程克隆操作**





假设已满足远程克隆前提条件，以下示例说明了整个过程：





#### **在 donor 上：**



```
CREATE USER 'donor_clone_user'@'example.donor.host.com' IDENTIFIED BY 'password';
GRANT BACKUP_ADMIN ON *.* TO 'donor_clone_user'@'example.donor.host.com';
INSTALL PLUGIN clone SONAME 'mysql_clone.so';
```



#### **在 recipient 上：**



```
CREATE USER 'recipient_clone_user'@'example.recipient.host.com' IDENTIFIED BY 'password';
GRANT CLONE_ADMIN ON *.* TO 'recipient_clone_user'@'example.recipient.host.com';
INSTALL PLUGIN clone SONAME 'mysql_clone.so';
SET GLOBAL clone_valid_donor_list = 'example.donor.host.com:3306';
```



#### **执行远程克隆：**



```
CLONE INSTANCE FROM 'donor_clone_user'@'example.donor.host.com':3306
   IDENTIFIED BY 'password';
```

克隆完成后，recipient 上的 MySQL 实例将自动重启。



------





### **使用命名目录进行克隆**





如果想保留 recipient 上现有数据，可在 CLONE INSTANCE 语句中使用 DATA DIRECTORY 子句。例如：

```
CLONE INSTANCE FROM 'user'@'example.donor.host.com':3306
   IDENTIFIED BY 'password'
   DATA DIRECTORY = '/path/to/clone_dir';
```



- 路径必须是 **绝对路径**，且目标目录 **不能已存在**。
- MySQL 必须有权限创建该目录。
- 在使用命名目录克隆时，服务器不会自动重启；如需使用克隆数据启动 MySQL，请手动执行：



```
$> mysqld_safe --datadir=/path/to/clone_dir
```



------





### **配置加密连接（SSL/TLS）**





要确保网络克隆过程中的数据安全，需在 recipient 上配置与 donor 匹配的 SSL 证书：



- 准备 donor 的证书文件，包括 ca.pem、client-cert.pem 和 client-key.pem，并确保 recipient 可以访问这些文件。
- 设置 recipient 的 clone 相关 SSL 参数：



```
clone_ssl_ca=/path/to/ca.pem
clone_ssl_cert=/path/to/client‑cert.pem
clone_ssl_key=/path/to/client‑key.pem
```



- 若要强制使用加密连接，需在克隆语句中加入 REQUIRE SSL：



```
CLONE INSTANCE FROM 'user'@'example.donor.host.com':3306
   IDENTIFIED BY 'password'
   DATA DIRECTORY = '/path/to/clone_dir'
   REQUIRE SSL;
```



- 若克隆的是加密数据，则必须使用加密连接，即使未指定 REQUIRE SSL，否则会报错；使用 REQUIRE NO SSL 克隆加密数据也会失败。





------



如需了解更多内容，如 [7.6.7.4 节：克隆与并发 DDL](#7-6-7-4-cloning-and-concurrent-ddl)、[7.6.7.5 节：克隆加密数据](#7-6-7-5-cloning‑encrypted‑data)、[7.6.7.6 节：克隆压缩数据](#7‑6‑7‑6‑cloning‑compressed‑data)，或 [7.6.7.10 节：监控克隆操作](#7‑6‑7‑10‑monitoring‑cloning‑operations)，可以按需继续查看。