

##### 7.6.7.9 远程克隆操作失败处理

本节介绍在克隆操作的不同阶段发生故障时的处理方式。

1. 会先检查克隆前提条件（见 [远程克隆的前提条件](#remote-cloning-prerequisites)）。

   - 如果在此阶段失败，`CLONE INSTANCE` 操作会报错。

2. 在 MySQL 8.0.27 之前，donor 和 recipient 上的备份锁会阻止并发 DDL 操作。从 MySQL 8.0.27 起，donor 上是否阻止并发 DDL 操作取决于变量 `clone_block_ddl` 是否为 `ON`（默认值为 `OFF`）。参见 [7.6.7.4 节，克隆与并发 DDL](#7-6-7-4-cloning-and-concurrent-ddl)。

   - 若克隆操作无法在 `clone_ddl_timeout` 指定的时间内获取 DDL 锁，则会报错。

3. 在克隆新数据前，会删除 recipient 上用户创建的数据（如 schemas、tables、tablespaces）和 binary logs。

   - 在远程克隆操作中从 recipient 的数据目录中删除用户数据和二进制日志时，这些数据不会被保存。如果过程中出现故障，这些数据可能会丢失。如果这些数据重要，建议在发起克隆操作前做好备份。

     服务器错误日志中会记录数据删除的起止信息，例如：

      ```
      [Warning] [MY-013453] [InnoDB] Clone removing all user data for provisioning: Started...
      [Warning] [MY-013453] [InnoDB] Clone removing all user data for provisioning: Finished
      ```

     如果在删除数据时发生错误，recipient 可能会保留部分旧的 schemas、tables 和 tablespaces。但在克隆执行期间或失败之后，服务器始终保持一致状态。

4. 当从 donor 克隆数据时，包括用户数据、字典元数据和其他系统数据都会被复制。

   - 如果在克隆数据过程中失败，克隆操作会回滚，所有已克隆的数据将被移除。此时 recipient 上原有的用户数据和二进制日志也已被删除。

     你可以修复错误并重新执行克隆，或放弃克隆，从之前的备份中恢复 recipient 数据。

5. 在远程克隆（非 DATA DIRECTORY 模式）中，克隆完成后服务器会自动重启，并执行常规启动任务。

   - 如果自动重启失败，你可以手动重启服务器以完成克隆流程。


**MySQL 8.0.24 之前**：若克隆期间发生网络错误，错误在 **5 分钟内**被修复，则克隆操作会继续。

**MySQL 8.0.24 起**：错误恢复时间由 donor 上变量 `clone_donor_timeout_after_network_failure` 控制，默认值为 **5 分钟**，支持 0 至 30 分钟范围。



- 如果在指定时间内未恢复，克隆操作将终止并返回错误，donor 会丢弃快照。
- 设置为 `0` 时，发生网络错误时 donor 会立即丢弃快照。
- 设置更长的超时时间可提供更多修复时间，但也会导致 donor 的增量数据更大，从而增加克隆恢复时间以及在用作副本或组成员时的复制延迟。







------





### **超时相关注意事项**





- **MySQL 8.0.24 之前**：donor 使用服务器的 `wait_timeout` 设置来监听克隆协议命令，过低的 `wait_timeout` 会导致长时间运行的克隆操作超时。
- **MySQL 8.0.24 起**：clone 的空闲超时时间使用默认 `wait_timeout` 设置，即 **28800 秒（8 小时）**。