#### 10.4.3.1 MySQL 如何打开和关闭表

当您执行 `mysqladmin status` 命令时，您应该会看到类似如下的输出：

```sql
Uptime: 426  Running threads: 1  Questions: 11082
Reloads: 1  Open tables: 12
```

如果您的表少于 12 个，`Open tables` 值为 12 可能会让人感到困惑。

MySQL 是多线程的，因此可能有许多客户端同时对给定表执行查询。为了尽量减少多个客户端会话在同一表上具有不同状态的问题，每个并发会话独立打开该表。这使用了额外的内存，但通常提高了性能。对于 MyISAM 表，每个打开表的客户端需要一个额外的数据文件描述符。（相反，索引文件描述符在所有会话之间共享。）

`table_open_cache` 和 `max_connections` 系统变量会影响服务器保持打开的文件的最大数量。如果增加这些值中的一个或两个，您可能会遇到操作系统对每个进程打开文件描述符数量的限制。许多操作系统允许您增加打开文件的限制，尽管方法因系统而异。请查阅您的操作系统文档，以确定是否可以增加限制以及如何操作。

`table_open_cache` 与 `max_connections` 相关。例如，对于 200 个并发运行的连接，指定的表缓存大小至少为 200 * N，其中 N 是任何查询中的每个连接所需的最大表数。您还必须为临时表和文件保留一些额外的文件描述符。

确保您的操作系统可以处理 `table_open_cache` 设置所暗示的打开文件描述符数量。如果 `table_open_cache` 设置得太高，MySQL 可能会耗尽文件描述符，并出现拒绝连接或无法执行查询等症状。

还要考虑到 MyISAM 存储引擎每个唯一打开的表需要两个文件描述符。要增加 MySQL 可用的文件描述符数量，请设置 `open_files_limit` 系统变量。请参阅 [B.3.2.16 文件未找到及类似错误](#B.3.2.16-文件未找到及类似错误)。

打开表的缓存保持在 `table_open_cache` 条目数量的水平。服务器在启动时自动调整缓存大小。要明确设置大小，请在启动时设置 `table_open_cache` 系统变量。MySQL 可能会暂时打开更多的表来执行查询，如本节后面所述。

MySQL 在以下情况下关闭未使用的表并将其从表缓存中移除：

- 当缓存已满且线程尝试打开不在缓存中的表时。
- 当缓存包含超过 `table_open_cache` 条目的表且缓存中的某个表不再被任何线程使用时。
- 当发生表刷新操作时。这发生在有人发出 `FLUSH TABLES` 语句或执行 `mysqladmin flush-tables` 或 `mysqladmin refresh` 命令时。

当表缓存已满时，服务器使用以下步骤定位要使用的缓存条目：

- 释放当前未使用的表，从最久未使用的表开始。
- 如果必须打开新表，但缓存已满且没有表可以释放，缓存会暂时扩展。缓存处于临时扩展状态时，表从使用状态变为未使用状态，该表会关闭并从缓存中释放。

每个并发访问会打开一个 MyISAM 表。这意味着如果两个线程访问同一个表，或一个线程在同一个查询中两次访问该表（例如，通过自连接），则该表需要被打开两次。每个并发打开需要一个表缓存条目。第一次打开任何 MyISAM 表需要两个文件描述符：一个用于数据文件，一个用于索引文件。表的每次额外使用仅需要一个用于数据文件的文件描述符。索引文件描述符在所有线程之间共享。

如果使用 `HANDLER tbl_name OPEN` 语句打开表，则会为线程分配一个专用的表对象。该表对象不与其他线程共享，直到线程调用 `HANDLER tbl_name CLOSE` 或线程终止时才关闭。此时，表会放回表缓存中（如果缓存未满）。请参阅 15.2.5 HANDLER 语句。

要确定表缓存是否太小，请检查 `Opened_tables` 状态变量，该变量指示自服务器启动以来的表打开操作数：

```sql
mysql> SHOW GLOBAL STATUS LIKE 'Opened_tables';
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| Opened_tables | 2741  |
+---------------+-------+
```

如果该值非常大或迅速增加，即使您没有发出许多 `FLUSH TABLES` 语句，也应在服务器启动时增加 `table_open_cache` 值。